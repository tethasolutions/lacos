<div class="d-flex align-items-center mb-3">
    <div class="col">
        <h3>Commenti</h3>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <button class="btn btn-primary me-2" (click)="resetFilter()" [disabled]="!hasFilter">Tutti</button>
        <button class="btn btn-primary" (click)="filterUnread()">Da leggere ({{unreadCounter}})</button>
    </div>
</div>

<app-grid-context-menu #gridMenu key="jobId"></app-grid-context-menu>

<kendo-grid id="messages-grid" [data]="data" [pageSize]="gridState.take" [skip]="gridState.skip" [sort]="gridState.sort"
    [filter]="gridState.filter" [group]="gridState.group" filterable="menu" [sortable]="true" [pageable]="true"
    scrollable="none" (dataStateChange)="dataStateChange($event)" [rowClass]="rowCallback"
    (cellClick)="cellClickHandler($event)" (dblclick)="onDblClick()" (cellClick)="gridMenu.onCellClick($event)">

    <kendo-grid-column field="isRead" [sortable]="false" [filterable]="false" title=" " [width]="1">
        <ng-template kendoGridCellTemplate let-dataItem>
            <div class="d-flex text-nowrap gap-1">
                <button class="btn btn-outline-primary btn-sm me-2" type="button"
                    title="Segna come letto" [disabled]="dataItem.isRead || dataItem.senderOperatorId == currentOperator.id "
                    (click)="markAsRead(dataItem)">
                    <i class="fa-regular fa-square-check" *ngIf="dataItem.isRead"></i>
                    <i class="fa-regular fa-square" *ngIf="!dataItem.isRead"></i>
                </button>
            </div>
        </ng-template>
    </kendo-grid-column>

    <kendo-grid-column field="senderOperator" title="Mittente" >
    </kendo-grid-column>
    <kendo-grid-column field="date" title="Data Messaggio" filter="date" format="dd/MM/yyyy" [width]="1">
        <ng-template kendoGridCellTemplate let-dataItem>
            <div class="text-nowrap">
                {{dataItem.date | date:'dd/MM/yyyy HH:mm'}}
            </div>
        </ng-template>
    </kendo-grid-column>
    <kendo-grid-column field="note" title="Messaggio" >
        <ng-template kendoGridCellTemplate let-dataItem>
            <div [innerHTML]="dataItem.note"></div>
        </ng-template>
    </kendo-grid-column>
    <kendo-grid-column field="jobCode" title="Comm." [width]="1">
        <ng-template kendoGridCellTemplate let-dataItem>
            <div *ngIf="!dataItem.jobHasHighPriority">{{dataItem.jobCode}}</div>
            <div *ngIf="dataItem.jobHasHighPriority" class="job-alert">
                {{dataItem.jobCode}} <i class="fa fa-exclamation-triangle" aria-hidden="true"></i>
            </div>
        </ng-template>
    </kendo-grid-column>
    <kendo-grid-column field="customerName" title="Cliente" >
    </kendo-grid-column>
    <kendo-grid-column field="jobReference" title="Riferimento" >
    </kendo-grid-column>
    <kendo-grid-column field="activityColor" [sortable]="false" [filterable]="false" title=" " class="activity-color">
        <ng-template kendoGridCellTemplate let-dataItem>
            <div [style.background-color]="dataItem.activityColor">&nbsp;</div>
        </ng-template>
    </kendo-grid-column>
    <kendo-grid-column field="activityDescription" title="AttivitÃ " >
    </kendo-grid-column>
    
    <kendo-grid-column field="targetOperators" title="Dest." >
        <ng-template kendoGridCellTemplate let-dataItem>
            <i class="fas fa-users" [title]="dataItem.targetOperators"></i>
        </ng-template>
    </kendo-grid-column>
    <kendo-grid-column field="id" [sortable]="false" [filterable]="false" title=" " [width]="1">
        <ng-template kendoGridCellTemplate let-dataItem>
            <div class="d-flex text-nowrap gap-1">
                <button [disabled]="dataItem.senderOperatorId != currentOperator.id" type="button"
                    class="btn btn-outline-primary btn-sm me-2" title="Modifica"
                    (click)="editMessage(dataItem)">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-primary btn-sm" title="Rispondi" (click)="createMessage(dataItem,false)">
                    <i class="fas fa-reply"></i>
                </button>
                <button class="btn btn-outline-primary btn-sm" title="Rispondi a tutti" (click)="createMessage(dataItem,true)">
                    <i class="fas fa-reply-all"></i>
                </button>
            </div>
        </ng-template>
    </kendo-grid-column>
</kendo-grid>

<app-message-modal #messageModal></app-message-modal>